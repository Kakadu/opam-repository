opam-version: "2.0"
authors:      "Kakadu@pm.me kakadu.hafanana@gmail.com"
maintainer:   "Kakadu"
license:      "LGPL-2.1-or-later"
homepage:     "http://kakadu.github.io/lablqml/"
bug-reports:  "https://github.com/kakadu/lablqml/issues"
dev-repo: "git+https://github.com/Kakadu/lablqml.git"
synopsis: "Installation of Qt5 using system packages or from source"
flags: conf

# TODO: There is a `setenv` syntax that should patch the environment for dependencies of this package
# At the moment it is reserved only for compiler packages, and it's usage gives a warning.
# But in principle it could simplify the life of the user of installed Qt
#setenv: [ PATH += "/usr/lib64/qt5/bin:/usr/lib/qt5/bin"] #{ os-distribution = "alpine" | os-distribution = "centos" | os-distribution = "fedora" }
#setenv: [
#  [ PKG_CONFIG_PATH += "/usr/local/opt/qt@5/lib/pkgconfig" ] 
#] #{ os="macos" } # not allowed here by opam syntax 

extra-files: [
  "configure.sh"
  "sha256=ec07b7ce43a2a17ef77ef322eba303f6fdc80bc907ca46791cabf73fb0cf81c3"
]

build: [
  ["sh" "-exc" "PATH=/usr/local/opt/qt@5/bin:$PATH sh ./configure.sh %{version}%" ]
    { os="macos" }
  ["sh" "-ex" "./configure.sh" "%{version}%" ]
    { os-family="debian" | os-distribution = "arch"  }
  ["sh" "-ex" "./configure.sh" "%{version}%" "-qt5" ]
    { os!="macos" & os-family != "debian" & os-distribution != "arch"  }
]

post-messages:
  "The Qt5 installed my brew shoudl be located at /usr/local/opt/qt@5. It's recommended to set PKG_CONFIG_PATH to /usr/local/opt/qt@5/lib/pkg-config to enable pkg-config, or fix PATH to get accces to Qt's tools. Also you may need to execute `brew link --force` to symlink everything properly. https://github.com/Kakadu/lablqml/issues/21#issuecomment-319489574 "
    { os = "macos" }

#depends: [ "conf-pkg-config"] 
# CI gave me: Error: An unexpected error occurred during the `brew link` step
# But in theory it could be used in configure.sh to compile 'Hello, world' or something like that.

depexts: [
  ["qt5"] {os = "macos" & os-distribution = "homebrew"}
  ["qtdeclarative5-dev" "qt5-qmake"]
    { os-family = "debian" & os-distribution != "ubuntu" }
  ["qt5-default"]
    { os-distribution = "debian" & os-version <= "10" }
  ["qt5-default" "qtdeclarative5-dev" "qt5-qmake"]
    { os-distribution = "ubuntu" & os-version < "21.04" }
  ["qtbase5-dev" "qtdeclarative5-dev" "qt5-qmake"]
    { os-distribution = "ubuntu" & os-version >= "21.04" }
  ["qt5-qmake"]
    { os-distribution = "oracle" }
  ["qt5-base" "qt5-declarative"]
    { os-distribution = "arch" }

  # to set right paths for qt5 automatically we should
  #   1) add `@edge http://nl.alpinelinux.org/alpine/edge/testing` to `/etc/apk/repositories`
  #   2) perform installation via `apk add qtchooser@edge`
  # but this repo is not shipped by default on CI
  ["qt5-qtbase-dev" "qt5-qtdeclarative-dev"]
    { os-distribution = "alpine" }

  # TODO: this packages provide `qmake-qt5` executable and I have no idea how to make
  # `qmake` be a symlink to there
  [ "qt5-qtbase-devel" "qt5-qtdeclarative-devel"]
    { os-distribution = "centos" }
  [ "qt-devel" ]
    { os-distribution = "centos" & os-version <= "7" }
  [ "qt5-qtbase-devel" "qt5-qtdeclarative-devel" #"qmake-qt5"
  ]
    { os-family = "fedora" }
  ["libqt5-qtbase-common-devel" "libqt5-qtbase-devel" "libqt5-qtdeclarative-devel" ]
    { os-family = "suse" }
]

